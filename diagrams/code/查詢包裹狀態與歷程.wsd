@startuml
autonumber
title Sequence Diagram: Track Parcel History (查詢包裹狀態與歷程)

' ▼▼▼ 字型設定 ▼▼▼
skinparam defaultFontName "Microsoft JhengHei"
skinparam handwritten false
skinparam shadowing false
skinparam wrapWidth 250

' --- 1. 角色定義 ---
actor "User\n(客戶/員工)" as User
participant "Web UI\n(網頁介面)" as UI
participant "app.py\n(後端控制器)" as Backend
participant "models.py\ndb_operations.py\n(資料庫模組)" as DB

' --- 2. 流程開始 ---

' [場景 1] 使用者輸入
User -> UI: 1. 輸入追蹤編號 (Tracking Number)\n或是點擊訂單詳情
activate UI

' [場景 2] 呼叫後端 API
UI -> Backend: 2. GET /api/parcels/{tracking_no}/history
activate Backend
note right: 需帶入 JWT Token (Header)\n因為有 @token_required

    ' [場景 3] 權限驗證 (Decorator)
    Backend -> Backend: 3. Verify Token (驗證登入狀態)
    
    alt Token 無效或過期
        Backend --> UI: 回傳 401 Unauthorized
        UI -> User: 顯示 "請重新登入"
    else 驗證通過
        
        ' [場景 4] 讀取歷史事件 (對應程式碼第 368 行)
        note right of Backend
          **Step A: 撈取完整歷程**
          (從 TrackingEvents 表讀取該單號的所有紀錄)
        end note
        Backend -> DB: 4. read_tracking_events(tracking_no)
        activate DB
        DB --> Backend: 回傳事件列表 (List of Events)
        deactivate DB

        ' [場景 5] 檢查是否有資料 (對應程式碼第 370 行)
        alt 查無紀錄 (Not Found)
            Backend --> UI: 回傳 200 OK (但 events 為空)
            UI -> User: 顯示 "查無此單號紀錄"
        else 成功取得資料
            
            ' [場景 6] 回傳 JSON (對應程式碼第 372 行)
            Backend --> UI: 回傳 JSON Data
            note right
              Response:
              {
                "tracking_number": "TRK-2025...",
                "events": [
                  {"status": "建立包裹", "time": "10:00", ...},
                  {"status": "運輸中", "vehicle_id": "Truck-A", ...},
                  {"status": "已送達", "operator": "driver1", ...}
                ]
              }
            end note

            ' [場景 7] 渲染畫面
            UI -> UI: Render Timeline (繪製時間軸)
            UI -> User: 顯示包裹完整運送軌跡
        end
    end

deactivate Backend
deactivate UI

@enduml


