@startuml
autonumber
title Sequence Diagram: Create Parcel (建立包裹流程)

' ▼▼▼ 字型設定 ▼▼▼
skinparam defaultFontName "Microsoft JhengHei"
skinparam handwritten false
skinparam shadowing false
skinparam wrapWidth 200

' --- 1. 角色定義 ---
actor "Sender/Staff\n(寄件人/員工)" as User
participant "Web UI\n(網頁介面)" as UI
participant "app.py\n(後端控制器)" as Backend
participant "models.py\ndb_operations.py\n(資料庫模組)" as DB

' --- 2. 流程開始 ---

' [場景 1] 輸入寄件資料
User -> UI: 1. 輸入寄件資訊\n(寄件人, 收件人, 地址, 重量, 箱型...)
activate UI

' [場景 2] 呼叫後端 API (對應 create_parcel)
UI -> Backend: 2. POST /api/parcels
activate Backend

' ▼▼▼ PM 備註：強調資料結構 ▼▼▼
note right
  Payload:
  {
    "sender": "user1",
    "receiver": "王小明",
    "weight": 5.2,
    "package_type": "中型箱",
    "contents": "書籍"
  }
end note

    ' [場景 3] 產生追蹤編號 (對應程式碼第 234 行)
    Backend -> Backend: 3. Generate Tracking Number\n(TRK-Date-Random)
    
    ' [場景 4] 建構資料 (對應程式碼第 238 行)
    Backend -> Backend: 4. Build Record\n(Status="建立包裹", Amount=None)

    ' [場景 5] 寫入包裹主檔 (對應程式碼第 251 行)
    note right of Backend
      **Step A: 存入包裹表**
      (此階段運費尚未計算，Amount 為空)
    end note
    Backend -> DB: 5. append_parcel(record)
    activate DB
    DB --> Backend: 寫入成功
    deactivate DB

    ' [場景 6] 自動記錄事件 (對應程式碼第 254 行)
    note right of Backend
      **Step B: 自動記錄物流事件**
      (系統自動觸發，無需人工介入)
    end note
    Backend -> DB: 6. append_tracking_event(\n{event_type: "建立包裹", ...})
    activate DB
    DB --> Backend: 事件記錄成功
    deactivate DB

    ' [場景 7] 回傳結果
    Backend --> UI: 回傳 201 Created\n(含 tracking_number)
    deactivate Backend

' [場景 8] 後續動作引導
UI -> User: 顯示「建立成功」並引導至付款頁面
note right: 下一步：前端計算運費後\n呼叫 set_parcel_amount API

deactivate UI

@enduml


