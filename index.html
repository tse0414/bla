<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>包裹追蹤與計費系統（三層式・進階版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ======= 全局樣式 ======= */
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif; }
    body { margin: 0; background: #f5f7fb; color: #222; }
    header { background: linear-gradient(120deg, #1f4f96, #2c7adf); color: #fff; padding: 16px 24px; display: flex; gap: 16px; align-items: center; justify-content: space-between; }
    header h1 { margin: 0; font-size: 18px; }
    header small { opacity: 0.9; }
    nav { display: flex; gap: 8px; padding: 8px 24px; background: #fff; position: sticky; top: 0; z-index: 5; box-shadow: 0 1px 3px rgba(0,0,0,.08); overflow-x:auto; }
    nav a { text-decoration: none; padding: 6px 12px; border-radius: 999px; background: #eef2f8; color: #111; white-space: nowrap; }
    nav a:hover { background: #d9e4ff; }
    main { padding: 16px 24px 80px; max-width: 1200px; margin: 0 auto; }
    .section { margin-top: 24px; }
    .section h2 { font-size: 18px; margin-bottom: 2px; color: #1f4f96; }
    .subtitle { color:#555; font-size:12px; margin-bottom:8px; }
    .card { background:#fff; border-radius:12px; padding:16px 18px; box-shadow:0 2px 6px rgba(15,23,42,.08); margin-top:12px; }
    .card h3 { margin:0 0 8px; font-size:16px; color:#0f172a; }
    .muted { color:#6b7280; font-size:12px; }
    form { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px 16px; margin-top:8px; font-size:13px; }
    label { display:flex; flex-direction:column; gap:4px; }
    input, select, textarea { padding:6px 8px; border:1px solid #d1d5db; border-radius:8px; font-size:13px; }
    textarea { min-height:64px; }
    .full { grid-column: 1 / -1; }
    .btn-row { grid-column: 1 / -1; display:flex; gap:8px; flex-wrap:wrap; }
    button { border:none; border-radius:999px; padding:6px 14px; font-size:13px; cursor:pointer; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-outline { background:#fff; color:#2563eb; border:1px solid #2563eb; }
    table { width:100%; border-collapse:collapse; font-size:12px; margin-top:10px; }
    th, td { border:1px solid #e5e7eb; padding:6px 8px; text-align:left; white-space:nowrap; }
    th { background:#f3f4f6; }
    .pill { display:inline-block; padding:2px 8px; font-size:11px; background:#e5e7eb; border-radius:999px; margin-right:4px; }
    .tag { display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; background:#eff6ff; color:#1d4ed8; margin-right:4px; margin-bottom:4px; }
    .divider { border-left: 4px solid #1f4f96; padding-left:10px; margin: 20px 0 8px; color:#1f4f96; font-weight:600; }
    .role-hint { font-size:12px; padding:8px; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:8px; }
    .role-only-client { border-left:3px solid #10b981; padding-left:6px; }
    .role-only-staff  { border-left:3px solid #f59e0b; padding-left:6px; }
    .role-only-admin  { border-left:3px solid #ef4444; padding-left:6px; }
    /* 後端 Log 面板 */
    .console { position: fixed; bottom: 0; left: 0; right: 0; height: 200px; background: #0b1020; color: #e5e7eb; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; overflow: auto; padding: 8px 12px; border-top: 3px solid #1f4f96; }
    .console h4 { margin:0 0 6px; font-size:12px; color:#a5b4fc; }
    .log-line { font-size:12px; line-height:1.5; white-space: pre-wrap; }
    .ok { color:#a7f3d0; }
    .warn { color:#fde68a; }
    .err { color:#fecaca; }
    .api { color:#93c5fd; }
    .db  { color:#c7d2fe; }
    /* 讓底部日誌不擋住內容 */
    .spacer { height: 220px; }
    @media (max-width:640px){ header, nav, main{ padding-left:16px; padding-right:16px; } .console{ height: 240px; } .spacer{ height: 260px; } }
  </style>
</head>
<body>
  <!-- ======== 介面層（展示層 / 前端） ======== -->
  <header>
    <div>
      <h1>包裹追蹤與計費系統</h1>
      <small>三層式架構・前端原型（含後端/資料層模擬）</small>
    </div>
    <div>
      <label style="font-size:12px;">
        目前角色：
        <select id="roleSelect" onchange="onRoleChange()" style="padding:4px 8px;border-radius:999px;border:none;">
          <option value="client">客戶（只能查詢自己的貨件）</option>
          <option value="staff">作業人員（客服/倉儲/駕駛）</option>
          <option value="admin" selected>管理員 / 系統管理員</option>
        </select>
      </label>
    </div>
  </header>

  <nav>
    <a href="#customer">客戶管理</a>
    <a href="#parcel">包裹建立</a>
    <a href="#tracking">追蹤與物流</a>
    <a href="#billing">計費與付款</a>
    <a href="#security">安全與權限</a>
  </nav>

  <main>
    <div class="divider">介面層（展示層 / 前端）</div>
    <p class="role-hint">此區塊提供「使用者操作介面」。所有按鈕會呼叫 <strong>應用層 API</strong>，由應用層處理商業邏輯並存取資料層。</p>

    <!-- 客戶管理 -->
    <section id="customer" class="section">
      <h2>客戶管理</h2>
      <div class="subtitle">對應架構：應用層「客戶管理模組」⇄ 資料層「客戶資料表」</div>

      <div class="card role-only-staff role-only-admin">
        <h3>新增 / 編輯客戶</h3>
        <form id="customerForm">
          <label>客戶帳號 <input name="account" type="text" placeholder="CUST-0001" required /></label>
          <label>姓名 <input name="name" type="text" placeholder="王小明" required /></label>
          <label>電子郵件 <input name="email" type="email" placeholder="example@mail.com" /></label>
          <label>電話 <input name="phone" type="tel" placeholder="09xx-xxx-xxx" /></label>
          <label class="full">地址 <input name="address" type="text" placeholder="縣市、區域、路名、門牌…" /></label>
          <label>客戶類型
            <select name="type">
              <option>合約客戶（月結帳戶）</option>
              <option>非合約客戶（現金 / 信用卡）</option>
              <option>預付客戶（第三方支付）</option>
            </select>
          </label>
          <div class="btn-row">
            <button type="button" class="btn-primary" onclick="uiCreateCustomer()">儲存</button>
            <button type="reset" class="btn-outline">清除</button>
          </div>
        </form>
        <div class="muted">成功新增後將顯示於下表；資料實際保存於 <code>localStorage</code>（資料層模擬）。</div>
        <table id="customerTable">
          <thead><tr><th>帳號</th><th>姓名</th><th>類型</th><th>電話</th><th>信箱</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 包裹建立 -->
    <section id="parcel" class="section">
      <h2>包裹建立</h2>
      <div class="subtitle">對應架構：應用層「包裹管理模組」⇄ 資料層「包裹資料表」</div>

      <div class="card role-only-staff role-only-admin">
        <h3>建立包裹（產生追蹤編號）</h3>
        <form id="parcelForm">
          <label>追蹤編號
            <div style="display:flex;gap:6px;">
              <input id="trackingInput" name="trackingId" type="text" placeholder="按『產生』自動生成" required />
              <button type="button" class="btn-outline" onclick="generateTrackingId()">產生</button>
            </div>
          </label>
          <label>寄件客戶帳號 <input name="senderAccount" type="text" placeholder="CUST-0001" required /></label>
          <label>收件人姓名 <input name="receiverName" type="text" required /></label>
          <label>收件人電話 <input name="receiverPhone" type="tel" /></label>
          <label class="full">收件地址 <input name="receiverAddress" type="text" /></label>
          <label>包裹類型
            <select name="parcelType"><option>小型箱</option><option>中型箱</option><option>大型箱</option></select>
          </label>
          <label>重量（kg） <input name="weight" type="number" step="0.01" /></label>
          <label>尺寸（長×寬×高，cm） <input name="size" type="text" placeholder="30 x 20 x 15" /></label>
          <label>配送時效
            <select name="serviceTime"><option>隔夜達</option><option>標準速遞</option><option>經濟速遞</option></select>
          </label>
          <label>申報價值（元） <input name="declaredValue" type="number" step="1" /></label>
          <label class="full">內容物描述 <textarea name="contentDesc" placeholder="書籍、衣物、電子產品…"></textarea></label>
          <label class="full">
            特殊服務標示
            <div>
              <label style="display:inline-flex;align-items:center;margin-right:12px;"><input name="flagDangerous" type="checkbox" /> 危險物品</label>
              <label style="display:inline-flex;align-items:center;margin-right:12px;"><input name="flagFragile" type="checkbox" /> 易碎品</label>
              <label style="display:inline-flex;align-items:center;"><input name="flagIntl" type="checkbox" /> 國際貨件要求</label>
            </div>
          </label>
          <div class="btn-row">
            <button type="button" class="btn-primary" onclick="uiCreateParcel()">儲存包裹</button>
            <button type="reset" class="btn-outline">清除</button>
          </div>
        </form>

        <table id="parcelTable">
          <thead><tr><th>追蹤編號</th><th>寄件帳號</th><th>收件人</th><th>類型</th><th>重量</th><th>時效</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 追蹤與物流 -->
    <section id="tracking" class="section">
      <h2>追蹤與物流</h2>
      <div class="subtitle">對應架構：應用層「追蹤事件管理模組」⇄ 資料層「追蹤事件資料表」</div>

      <div class="card">
        <h3>包裹查詢（客戶端）</h3>
        <form id="queryForm">
          <label class="full">追蹤編號 <input name="trackingId" type="text" placeholder="TRK-20251202-123" required /></label>
          <div class="btn-row">
            <button type="button" class="btn-primary" onclick="uiQueryTracking()">查詢包裹狀態</button>
            <button type="reset" class="btn-outline">清除</button>
          </div>
        </form>
        <div id="queryResult" class="muted">尚未查詢</div>
      </div>

      <div class="card role-only-staff role-only-admin">
        <h3>新增追蹤事件（內部）</h3>
        <form id="eventForm">
          <label>追蹤編號 <input name="trackingId" type="text" placeholder="TRK-..." required /></label>
          <label>事件時間 <input name="time" type="datetime-local" required /></label>
          <label>事件類型
            <select name="type"><option>起運地收件</option><option>進入貨車</option><option>進入倉儲</option><option>配送中</option><option>最終投遞</option><option>簽收完成</option><option>延誤</option><option>遺失</option><option>損毀</option></select>
          </label>
          <label>地點/倉儲代碼 <input name="location" type="text" placeholder="WH-TPE-01" /></label>
          <label class="full">說明 <input name="note" type="text" placeholder="簡要說明…" /></label>
          <div class="btn-row">
            <button type="button" class="btn-primary" onclick="uiAddEvent()">加入事件</button>
            <button type="reset" class="btn-outline">清除</button>
          </div>
        </form>
      </div>
    </section>

    <!-- 計費與付款 -->
    <section id="billing" class="section">
      <h2>計費與付款</h2>
      <div class="subtitle">對應架構：應用層「計費與帳單模組」⇄ 資料層「帳單資料表」</div>

      <div class="card">
        <h3>試算運費</h3>
        <form id="calcForm">
          <label>服務類型
            <select name="service"><option value="150">隔夜達</option><option value="120">標準速遞</option><option value="90">經濟速遞</option></select>
          </label>
          <label>距離（km） <input name="distance" type="number" step="1" placeholder="30" /></label>
          <label>重量（kg） <input name="weight" type="number" step="0.1" placeholder="2.5" /></label>
          <label>體積（立方公分） <input name="volume" type="number" step="1" placeholder="12000" /></label>
          <label class="full">
            特殊處理
            <div>
              <label style="display:inline-flex;align-items:center;margin-right:12px;"><input name="dangerous" type="checkbox" /> 危險品（+80）</label>
              <label style="display:inline-flex;align-items:center;margin-right:12px;"><input name="fragile" type="checkbox" /> 易碎（+50）</label>
              <label style="display:inline-flex;align-items:center;"><input name="oversize" type="checkbox" /> 超大件（+100）</label>
            </div>
          </label>
          <div class="btn-row">
            <button type="button" class="btn-primary" onclick="uiCalc()">計算預估運費</button>
          </div>
        </form>
        <div id="calcResult" class="muted">尚未計算</div>
      </div>

      <div class="card role-only-staff role-only-admin">
        <h3>帳單紀錄（示意）</h3>
        <table id="invoiceTable">
          <thead><tr><th>客戶</th><th>計費週期</th><th>金額</th><th>付款方式</th><th>狀態</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 安全與權限 -->
    <section id="security" class="section">
      <h2>安全與權限</h2>
      <div class="subtitle">應用層將根據角色（客戶/作業/管理）限制 API 與欄位可見性；資料層需進一步做資料授權。</div>
      <div class="card">
        <h3>角色與權限範例</h3>
        <div class="muted">切換右上角角色試試看，前端只做 <em>顯示/隱藏</em> 示意；實務上權限控管必須在 <strong>應用層＋資料層</strong>落實。</div>
        <div style="margin-top:6px;">
          <span class="tag">客戶服務人員</span>
          <span class="tag">倉儲人員</span>
          <span class="tag">駕駛員</span>
          <span class="tag">管理人員</span>
          <span class="tag">系統管理員</span>
        </div>
      </div>
    </section>

    <div class="spacer"></div>
  </main>

  <!-- ======== 應用層（商業邏輯層 / 後端服務・模擬） ======== -->
  <script>
    /*********************
     *    應用層總覽     *
     *********************
     - 透過 fetchAPI() 模擬 REST API 呼叫與延遲
     - Service：封裝商業邏輯與驗證
     - Router：將 URL 轉到對應 Service 方法
     - 權限檢查：根據 role 實作簡易允許/禁止
    ************************/

    /* === 系統公用 === */
    const Log = { el: null };
    function logLine(kind, msg){
      const line = document.createElement('div');
      line.className = 'log-line ' + (kind || '');
      const time = new Date().toLocaleTimeString();
      line.textContent = '['+time+'] ' + msg;
      Log.el?.appendChild(line);
      Log.el?.scrollTo({ top: Log.el.scrollHeight });
    }
    function logAPI(msg){ logLine('api', msg); }
    function logDB(msg){ logLine('db',  msg); }
    function logOK(msg){ logLine('ok',  msg); }
    function logWARN(msg){ logLine('warn', msg); }
    function logERR(msg){ logLine('err', msg); }

    /* === 假登入 / 角色 === */
    function getRole(){ return document.getElementById('roleSelect').value; }

    /* === 資料層：見下方 Data Layer（localStorage） === */
    // 這裡僅宣告介面，由 Data Layer 實作：DB.insert / DB.find / DB.update / DB.delete / DB.all

    /* === Service：商業邏輯 === */
    const CustomerService = {
      create(data){
        if(!data.account || !data.name) throw new Error('customer: account 與 name 為必填');
        // 權限：非客戶可建
        const role = getRole();
        if(role === 'client') throw new Error('權限不足：客戶不可建立客戶資料');
        // 不重複帳號
        const exists = DB.find('customers', c => c.account === data.account).length > 0;
        if(exists) throw new Error('customer: 帳號已存在');
        DB.insert('customers', { ...data, createdAt: Date.now() });
        return { ok:true };
      },
      list(){ return DB.all('customers'); }
    };

    const ParcelService = {
      create(data){
        const role = getRole();
        if(role === 'client') throw new Error('權限不足：客戶不可建立包裹');
        if(!data.trackingId || !data.senderAccount) throw new Error('parcel: trackingId 與 senderAccount 必填');
        const sender = DB.find('customers', c => c.account === data.senderAccount)[0];
        if(!sender) throw new Error('parcel: 找不到寄件客戶帳號');
        const dup = DB.find('parcels', p => p.trackingId === data.trackingId)[0];
        if(dup) throw new Error('parcel: 追蹤編號重複');
        DB.insert('parcels', { ...data, createdAt: Date.now() });
        return { ok:true };
      },
      list(){ return DB.all('parcels'); },
      get(trackingId){
        const p = DB.find('parcels', x => x.trackingId === trackingId)[0];
        if(!p) throw new Error('找不到該追蹤編號');
        return p;
      }
    };

    const TrackingService = {
      addEvent(ev){
        const role = getRole();
        if(role === 'client') throw new Error('權限不足：客戶不可新增事件');
        if(!ev.trackingId || !ev.time || !ev.type) throw new Error('tracking: 欄位不足');
        const p = ParcelService.get(ev.trackingId);
        DB.insert('trackingEvents', { ...ev, createdAt: Date.now() });
        return { ok:true, parcel: p };
      },
      query(trackingId){
        const p = ParcelService.get(trackingId);
        const events = DB.find('trackingEvents', e => e.trackingId === trackingId)
                         .sort((a,b)=> (a.time||'').localeCompare(b.time||''));
        return { parcel: p, events };
      }
    };

    const BillingService = {
      calculate({ base, distance=0, weight=0, volume=0, dangerous=false, fragile=false, oversize=false }){
        base = Number(base||0); distance=Number(distance||0); weight=Number(weight||0); volume=Number(volume||0);
        let extra = 0; if(dangerous) extra += 80; if(fragile) extra += 50; if(oversize) extra += 100;
        let price = base + distance * 2 + weight * 10 + extra;
        if (volume > 0) price += Math.round(volume / 10000) * 20;
        return Math.round(price);
      },
      list(){ return DB.all('invoices'); },
      createInvoice({ customerAccount, period, amount, method='月結（匯款）', status='已出帳' }){
        DB.insert('invoices', { customerAccount, period, amount, method, status, createdAt: Date.now() });
        return { ok:true };
      }
    };

    /* === Router / API 模擬 === */
    const Router = {
      async handle({ url, method='GET', body }){
        // 超簡易路由：/api/<resource>
        const [_, api, resource] = url.split('/');
        if(api !== 'api') throw new Error('Unknown endpoint');

        switch(resource){
          case 'customers':
            if(method==='POST') return CustomerService.create(body);
            if(method==='GET')  return CustomerService.list();
            break;
          case 'parcels':
            if(method==='POST') return ParcelService.create(body);
            if(method==='GET')  return ParcelService.list();
            break;
          case 'tracking':
            if(method==='POST') return TrackingService.addEvent(body);
            if(method==='GET')  return TrackingService.query(body.trackingId);
            break;
          case 'billing':
            if(method==='POST') return BillingService.createInvoice(body);
            if(method==='GET')  return BillingService.list();
            break;
          case 'calc':
            if(method==='POST') return { price: BillingService.calculate(body) };
            break;
          default: throw new Error('Unknown resource: '+resource);
        }
        throw new Error('Unsupported method');
      }
    };

    async function fetchAPI(url, { method='GET', body }={}){
      logAPI(method + ' ' + url + (body? ' ' + JSON.stringify(body):''));
      // 模擬網路延遲
      await new Promise(r=>setTimeout(r, 120));
      try{
        const res = await Router.handle({ url, method, body });
        logOK('→ ' + JSON.stringify(res));
        return res;
      }catch(err){
        logERR('× ' + err.message);
        throw err;
      }
    }

    /*********************
     *   介面層 ↔ 應用層  *
     *********************/
    // 角色切換（僅做前端顯示/隱藏示意）
    function onRoleChange(){
      const role = getRole();
      document.querySelectorAll('.role-only-client,.role-only-staff,.role-only-admin').forEach(el=> el.style.display = '');
      if(role==='client'){
        document.querySelectorAll('.role-only-staff,.role-only-admin').forEach(el=> el.style.display='none');
      }else if(role==='staff'){
        document.querySelectorAll('.role-only-admin').forEach(el=> el.style.display='none');
      }
    }

    // UI：建立客戶
    async function uiCreateCustomer(){
      const fd = Object.fromEntries(new FormData(document.getElementById('customerForm')).entries());
      try{
        await fetchAPI('/api/customers', { method:'POST', body: fd });
        await refreshCustomers();
        document.getElementById('customerForm').reset();
      }catch(e){ alert(e.message); }
    }
    async function refreshCustomers(){
      const list = await fetchAPI('/api/customers', { method:'GET' });
      const tbody = document.querySelector('#customerTable tbody');
      tbody.innerHTML = list.map(c=>`<tr><td>${c.account}</td><td>${c.name}</td><td>${c.type||''}</td><td>${c.phone||''}</td><td>${c.email||''}</td></tr>`).join('');
    }

    // UI：建立包裹
    function generateTrackingId(){
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,'0');
      const d = String(now.getDate()).padStart(2,'0');
      const rand = Math.floor(Math.random()*900+100);
      document.getElementById('trackingInput').value = `TRK-${y}${m}${d}-${rand}`;
    }
    async function uiCreateParcel(){
      const el = document.getElementById('parcelForm');
      const data = Object.fromEntries(new FormData(el).entries());
      data.flagDangerous = !!el.flagDangerous?.checked;
      data.flagFragile = !!el.flagFragile?.checked;
      data.flagIntl = !!el.flagIntl?.checked;
      try{
        await fetchAPI('/api/parcels', { method:'POST', body: data });
        await refreshParcels();
        el.reset();
      }catch(e){ alert(e.message); }
    }
    async function refreshParcels(){
      const list = await fetchAPI('/api/parcels', { method:'GET' });
      const tbody = document.querySelector('#parcelTable tbody');
      tbody.innerHTML = list.map(p=>`<tr><td>${p.trackingId}</td><td>${p.senderAccount}</td><td>${p.receiverName||''}</td><td>${p.parcelType||''}</td><td>${p.weight||''}</td><td>${p.serviceTime||''}</td></tr>`).join('');
    }

    // UI：追蹤查詢 / 新增事件
    async function uiQueryTracking(){
      const fd = Object.fromEntries(new FormData(document.getElementById('queryForm')).entries());
      try{
        const res = await fetchAPI('/api/tracking', { method:'GET', body: { trackingId: fd.trackingId } });
        const eventsHTML = res.events.length
          ? ('<table><thead><tr><th>時間</th><th>事件</th><th>地點</th><th>說明</th></tr></thead><tbody>' +
              res.events.map(e=>`<tr><td>${e.time||''}</td><td>${e.type||''}</td><td>${e.location||''}</td><td>${e.note||''}</td></tr>`).join('') + '</tbody></table>')
          : '<div class="muted">尚無事件紀錄</div>';
        document.getElementById('queryResult').innerHTML =
          `<div class="pill">追蹤編號：${res.parcel.trackingId}</div>
           <div class="pill">寄件：${res.parcel.senderAccount}</div>
           <div style="margin-top:6px;"></div>${eventsHTML}`;
      }catch(e){ alert(e.message); }
    }
    async function uiAddEvent(){
      const data = Object.fromEntries(new FormData(document.getElementById('eventForm')).entries());
      try{
        await fetchAPI('/api/tracking', { method:'POST', body: data });
        document.getElementById('eventForm').reset();
        // 若目前查詢欄有相同編號，幫你刷新
        const q = document.querySelector('#queryForm [name=trackingId]').value;
        if(q && q === data.trackingId) uiQueryTracking();
      }catch(e){ alert(e.message); }
    }

    // UI：計算費用 / 帳單列舉
    async function uiCalc(){
      const el = document.getElementById('calcForm');
      const data = Object.fromEntries(new FormData(el).entries());
      const priceRes = await fetchAPI('/api/calc', { method:'POST', body: {
        base: data.service, distance: data.distance, weight: data.weight, volume: data.volume,
        dangerous: !!el.dangerous.checked, fragile: !!el.fragile.checked, oversize: !!el.oversize.checked
      }});
      document.getElementById('calcResult').textContent = `預估運費：${priceRes.price} 元（示意）`;
      // 也示範建立一筆帳單（管理員/作業可用）
      const role = getRole();
      if(role !== 'client'){
        await fetchAPI('/api/billing', { method:'POST', body: { customerAccount: 'CUST-0001', period: '2025-12', amount: priceRes.price, method: '月結（匯款）', status:'已出帳' } });
        await refreshInvoices();
      }
    }
    async function refreshInvoices(){
      const list = await fetchAPI('/api/billing', { method:'GET' });
      const tbody = document.querySelector('#invoiceTable tbody');
      tbody.innerHTML = list.map(i=>`<tr><td>${i.customerAccount}</td><td>${i.period}</td><td>${i.amount}</td><td>${i.method}</td><td>${i.status}</td></tr>`).join('');
    }

    // 初始化
    window.addEventListener('DOMContentLoaded', async () => {
      Log.el = document.getElementById('consoleBody');
      onRoleChange();
      await seedIfEmpty();
      await refreshCustomers();
      await refreshParcels();
      await refreshInvoices();
      logOK('系統已就緒 ✅');
    });
  </script>

  <!-- ======== 資料層（資料儲存層・Database 模擬） ======== -->
  <script>
    /****************************
     *         Data Layer       *
     ****************************
     - 使用 localStorage 持久化
     - 提供 DB.insert / DB.find / DB.update / DB.delete / DB.all
     - 以多張「表」模擬：customers / parcels / trackingEvents / invoices / users
    *****************************/

    const STORE_KEY = 'parcelSysDB_v1';
    const Database = loadDB() || { customers:[], parcels:[], trackingEvents:[], invoices:[], users:[] };

    function persist(){ localStorage.setItem(STORE_KEY, JSON.stringify(Database)); logDB('commit ✓'); }
    function loadDB(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY) || ''); }catch{ return null; } }

    const DB = {
      insert(table, row){
        if(!Database[table]) Database[table] = [];
        Database[table].push(row);
        logDB(`INSERT ${table}: `+JSON.stringify(row));
        persist();
      },
      find(table, predicate){ const res = (Database[table]||[]).filter(predicate); logDB(`SELECT ${table} -> ${res.length} row(s)`); return res; },
      update(table, predicate, updater){
        let cnt=0;
        Database[table] = (Database[table]||[]).map(r=>{
          if(predicate(r)){ cnt++; const nr = updater({...r}); logDB(`UPDATE ${table}: `+JSON.stringify({before:r, after:nr})); return nr; }
          return r;
        });
        if(cnt) persist();
        return cnt;
      },
      delete(table, predicate){
        const before = (Database[table]||[]).length;
        Database[table] = (Database[table]||[]).filter(r=> !predicate(r));
        const del = before - Database[table].length;
        if(del) { logDB(`DELETE ${table}: ${del} row(s)`); persist(); }
        return del;
      },
      all(table){ return [...(Database[table]||[])]; }
    };

    // 預置資料（只在空庫時注入示意資料）
    async function seedIfEmpty(){
      if((Database.customers||[]).length === 0){
        DB.insert('customers', { account:'CUST-0001', name:'王小明', email:'xm_wang@example.com', phone:'0912-345-678', type:'合約客戶（月結帳戶）', createdAt: Date.now() });
        DB.insert('customers', { account:'CUST-0002', name:'陳小姐', email:'chen@example.com', phone:'0988-222-333', type:'非合約客戶（現金 / 信用卡）', createdAt: Date.now() });
      }
      if((Database.parcels||[]).length === 0){
        DB.insert('parcels', { trackingId:'TRK-20251202-101', senderAccount:'CUST-0001', receiverName:'李先生', parcelType:'中型箱', weight:1.2, serviceTime:'標準速遞', createdAt: Date.now() });
      }
      if((Database.trackingEvents||[]).length === 0){
        DB.insert('trackingEvents', { trackingId:'TRK-20251202-101', time:'2025-12-01 09:12', type:'起運地收件', location:'台北門市', note:'收件完成', createdAt: Date.now() });
        DB.insert('trackingEvents', { trackingId:'TRK-20251202-101', time:'2025-12-01 14:30', type:'進入貨車', location:'WH-TPE-01', note:'裝車完成', createdAt: Date.now() });
      }
      if((Database.invoices||[]).length === 0){
        DB.insert('invoices', { customerAccount:'CUST-0001', period:'2025-11', amount:12800, method:'月結（匯款）', status:'已出帳', createdAt: Date.now() });
      }
    }
  </script>

  <!-- ======== 後端日誌面板（僅示意） ======== -->
  <div class="console" id="console">
    <h4>系統後端日誌（模擬 Router / Service / DB）</h4>
    <div id="consoleBody"></div>
  </div>
</body>
</html>
