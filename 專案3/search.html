<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>進階查詢 - 包裹追蹤</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eff6ff;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1000px;
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      padding: 24px 28px 28px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
    }
    h1 {
      margin: 0;
      font-size: 24px;
      color: #111827;
    }
    p {
      margin: 0 0 24px;
      font-size: 14px;
      color: #6b7280;
    }
    label {
      display: inline-block;
      font-size: 14px;
      color: #374151;
      margin-right: 8px;
      margin-bottom: 6px;
    }
    input {
      padding: 7px 8px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      margin-right: 12px;
      margin-bottom: 8px;
    }
    .btn {
      padding: 9px 20px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      margin-left: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      text-align: left;
    }
    th {
      background: #f9fafb;
      color: #374151;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 13px;
      color: #6b7280;
    }
    .user-info {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="top-bar">
      <div>
        <h1>進階查詢 - 包裹追蹤</h1>
        <div class="user-info">
          登入帳號：<span id="currentUser">(未登入)</span>
          ｜ 角色：<span id="currentRole">未知</span>
        </div>
      </div>
      <div>
        <!-- ✅ 只有作業人員 / 管理人員會看到 -->
        <button
          id="btnDownloadExcel"
          class="btn btn-primary"
          style="margin-right: 8px;"
          onclick="downloadExcel()"
        >
          下載 Excel（全部資料）
        </button>
        <button class="btn btn-secondary" onclick="backToParcel()">
          返回儲存包裹
        </button>
      </div>
    </div>

    <p>可依追蹤編號、寄件人帳號、收件人姓名、日期範圍進行查詢。</p>

    <div>
      <label>追蹤編號</label>
      <input id="qTracking" placeholder="例如：TRK-20250101-0001" />

      <label>寄件人帳號</label>
      <input id="qSender" placeholder="例如：customerA" />

      <label>收件人</label>
      <input id="qReceiver" placeholder="部分姓名即可" />

      <label>開始日期</label>
      <input id="qStart" type="date" />

      <label>結束日期</label>
      <input id="qEnd" type="date" />

      <button class="btn btn-primary" onclick="searchRecords()">搜尋</button>
      <button class="btn btn-secondary" onclick="resetFilters()">清除</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>追蹤編號</th>
          <th>寄件人帳號</th>
          <th>收件人</th>
          <th>重量 (kg)</th>
          <th>體積</th>
          <th>建立日期</th>
        </tr>
      </thead>
      <tbody id="resultBody">
        <!-- 查詢結果 -->
      </tbody>
    </table>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:5000";

    let allRecords = [];
    let currentRole = "customer";

    function backToParcel() {
      window.location.href = "parcel_tracking.html";
    }

    async function loadAllRecords() {
      try {
        const res = await fetch(`${API_BASE}/records`);
        const data = await res.json();
        allRecords = Array.isArray(data) ? data : [];
        renderTable(allRecords);
      } catch (err) {
        console.error(err);
        alert("載入資料時發生錯誤");
      }
    }

    function renderTable(records) {
      const tbody = document.getElementById("resultBody");
      tbody.innerHTML = "";
      if (!records.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.textContent = "目前尚無符合條件的包裹資料";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      records.forEach((r) => {
        const tr = document.createElement("tr");

        const td1 = document.createElement("td");
        td1.textContent = r.tracking_no || "";
        tr.appendChild(td1);

        const td2 = document.createElement("td");
        td2.textContent = r.sender_id || "";
        tr.appendChild(td2);

        const td3 = document.createElement("td");
        td3.textContent = r.receiver_name || "";
        tr.appendChild(td3);

        const td4 = document.createElement("td");
        td4.textContent = r.weight || "";
        tr.appendChild(td4);

        const td5 = document.createElement("td");
        td5.textContent = r.volume || "";
        tr.appendChild(td5);

        const td6 = document.createElement("td");
        td6.textContent = r.date || "";
        tr.appendChild(td6);

        tbody.appendChild(tr);
      });
    }

    function searchRecords() {
      const t = document.getElementById("qTracking").value.trim();
      const s = document.getElementById("qSender").value.trim();
      const r = document.getElementById("qReceiver").value.trim();
      const start = document.getElementById("qStart").value;
      const end = document.getElementById("qEnd").value;

      let filtered = allRecords.slice();

      if (t) {
        filtered = filtered.filter((x) =>
          (x.tracking_no || "").toLowerCase().includes(t.toLowerCase())
        );
      }
      if (s) {
        filtered = filtered.filter((x) =>
          (x.sender_id || "").toLowerCase().includes(s.toLowerCase())
        );
      }
      if (r) {
        filtered = filtered.filter((x) =>
          (x.receiver_name || "").toLowerCase().includes(r.toLowerCase())
        );
      }
      if (start) {
        filtered = filtered.filter(
          (x) => x.date && x.date >= start
        );
      }
      if (end) {
        filtered = filtered.filter(
          (x) => x.date && x.date <= end
        );
      }

      renderTable(filtered);
    }

    function resetFilters() {
      document.getElementById("qTracking").value = "";
      document.getElementById("qSender").value = "";
      document.getElementById("qReceiver").value = "";
      document.getElementById("qStart").value = "";
      document.getElementById("qEnd").value = "";
      renderTable(allRecords);
    }

    async function downloadExcel() {
      // 只在前端給作業人員 / 管理人員按得到（按鈕已隱藏給客戶）
      try {
        const res = await fetch(`${API_BASE}/api/download`);
        if (!res.ok) {
          alert("下載失敗");
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "logistics.xlsx";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        alert("下載時發生錯誤");
      }
    }

    function initSearch() {
      const username = localStorage.getItem("username") || "";
      currentRole = localStorage.getItem("role") || "customer";

      document.getElementById("currentUser").textContent =
        username || "(未登入)";
      document.getElementById("currentRole").textContent =
        currentRole === "admin"
          ? "管理人員"
          : currentRole === "staff"
          ? "作業人員"
          : "客戶";

      const btn = document.getElementById("btnDownloadExcel");
      if (btn) {
        if (currentRole === "staff" || currentRole === "admin") {
          btn.style.display = "inline-block";
        } else {
          btn.style.display = "none";
        }
      }

      // 載入所有包裹資料
      loadAllRecords();
    }

    window.addEventListener("load", initSearch);
  </script>
</body>
</html>
