<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>步驟一：客戶基本資料</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: #f5f7fb; color: #222; }
    header {
      background: linear-gradient(120deg, #1f4f96, #2c7adf);
      color: #fff; padding: 16px 32px;
      display: flex; align-items: center; justify-content: space-between;
    }
    header h1 { margin: 0; font-size: 20px; }
    header small { font-size: 12px; opacity: .8; }
    nav {
      display: flex; gap: 8px; padding: 8px 32px;
      background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,.08);
    }
    nav a {
      text-decoration: none; padding: 6px 12px; border-radius: 999px;
      font-size: 13px; color: #333; background: #eef2f8;
    }
    nav a:hover { background: #d9e4ff; }
    main {
      padding: 16px 32px 40px; max-width: 900px; margin: 0 auto;
    }
    .section h2 { font-size: 18px; color: #1f4f96; margin-bottom: 4px; }
    .section small { font-size: 12px; color: #6b7280; }
    .card {
      background: #fff; border-radius: 12px; padding: 16px 20px;
      margin-top: 12px; box-shadow: 0 2px 5px rgba(15,23,42,.08);
    }
    form {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
      gap: 12px 16px; margin-top: 10px; font-size: 13px;
    }
    label { display: flex; flex-direction: column; font-size: 13px; color: #111827; }
    input, select, textarea {
      margin-top: 4px; padding: 6px 8px; border-radius: 8px;
      border: 1px solid #d1d5db; font-size: 13px; resize: vertical;
    }
    textarea { min-height: 60px; }
    .full-width { grid-column: 1 / -1; }
    .btn-row {
      grid-column: 1 / -1; display: flex; gap: 8px;
      margin-top: 4px; flex-wrap: wrap;
    }
    button {
      border: none; border-radius: 999px; padding: 6px 14px;
      font-size: 13px; cursor: pointer;
    }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-outline { background: #fff; color: #2563eb; border: 1px solid #2563eb; }
    @media (max-width: 640px) {
      header, nav, main { padding-left: 16px; padding-right: 16px; }
    }
  </style>
</head>
<body>
<header>
  <h1>包裹追蹤與計費系統 - 步驟一</h1>
  <div>
    <small style="margin-right:8px;">填寫客戶基本資料</small>
    <label style="font-size:12px;">
      目前角色：
      <select id="roleSelect" onchange="onRoleChange()" style="padding:4px 8px;border-radius:999px;border:none;">
        <option value="client">客戶</option>
        <option value="staff">作業人員</option>
        <option value="admin">管理員 / 系統管理員</option>
      </select>
    </label>
  </div>
</header>


<nav>
  <a href="customer.html">步驟一：客戶資料</a>
  <a href="parcel_tracking.html">步驟二：包裹與追蹤</a>
  <a href="billing.html">步驟三：計費與帳單</a>
</nav>

<main>
  <section class="section">
    <h2>客戶基本資料</h2>
    <small>請先填寫您的基本資料，下一步會進入包裹服務與收件資訊。</small>

    <div class="card">
      <form id="customerForm">
        <label>
          客戶姓名
          <input id="custName" type="text" placeholder="例如：王小明" required />
        </label>

        <label>
          電子郵件
          <input id="custEmail" type="email" placeholder="example@mail.com" required />
        </label>

        <label>
          聯絡電話
          <input id="custPhone" type="tel" placeholder="09xx-xxx-xxx" required />
        </label>

        <label>
          客戶帳號（系統自動產生）
          <div style="display:flex; gap:6px;">
            <input id="custId" type="text" placeholder="按『產生』自動產生" readonly required />
            <button type="button" class="btn-outline" onclick="generateCustomerId()">產生</button>
          </div>
        </label>


        <label class="full-width">
          地址
          <input id="custAddress" type="text" placeholder="縣市、區域、路名、門牌…" required />
        </label>

        <label>
          客戶類型
          <select id="custType">
            <option>合約客戶（月結帳戶）</option>
            <option>非合約客戶（現金 / 信用卡）</option>
            <option>預付客戶（由第三方支付）</option>
          </select>
        </label>

        <label>
          帳單偏好設定
          <select id="billingPref">
            <option>月結帳單</option>
            <option>貨到付款</option>
            <option>預付（交件時已付清）</option>
          </select>
        </label>

        <label class="full-width">
          備註
          <textarea id="custNote" placeholder="例如：長期合作、重要客戶、特別帳單需求…"></textarea>
        </label>

        <div class="btn-row">
          <button type="button" class="btn-primary" onclick="goNext()">下一步：包裹與追蹤</button>
          <button type="reset" class="btn-outline">清除表單</button>
        </div>
      </form>
    </div>
  </section>
</main>

<script>
  // 初始化角色
  function initRole() {
    const sel = document.getElementById('roleSelect');
    if (!sel) return;
    const saved = localStorage.getItem('currentRole') || 'client';
    sel.value = saved;
  }

  function onRoleChange() {
    const sel = document.getElementById('roleSelect');
    if (!sel) return;
    localStorage.setItem('currentRole', sel.value);
  }

  // 產生不重複的客戶帳號：CUST-YYYYMMDD-XXXX
  function generateCustomerId() {
    const today = new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth() + 1).padStart(2, '0');
    const d = String(today.getDate()).padStart(2, '0');

    const customers = JSON.parse(localStorage.getItem('customers') || '[]');

    function createId() {
      const rand4 = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
      return `CUST-${y}${m}${d}-${rand4}`;
    }

    let id = createId();
    // 簡單避免重複：最多試 10 次
    let tries = 0;
    while (customers.some(c => c.id === id) && tries < 10) {
      id = createId();
      tries++;
    }

    document.getElementById('custId').value = id;
  }

  // 按「下一步」時：存 currentCustomer + customers 陣列
  function goNext() {
    const data = {
      name: document.getElementById('custName').value.trim(),
      email: document.getElementById('custEmail').value.trim(),
      phone: document.getElementById('custPhone').value.trim(),
      id: document.getElementById('custId').value.trim(),
      address: document.getElementById('custAddress').value.trim(),
      type: document.getElementById('custType').value,
      billingPref: document.getElementById('billingPref').value,
      note: document.getElementById('custNote').value.trim()
    };

    if (!data.name || !data.email || !data.phone || !data.id || !data.address) {
      alert('請先把必填欄位填寫完成（姓名、Email、電話、帳號、地址）');
      return;
    }

    // 存「目前這一位」客戶
    localStorage.setItem('currentCustomer', JSON.stringify(data));

    // 更新 customers 陣列：同 id 則覆蓋，沒有就新增
    const customers = JSON.parse(localStorage.getItem('customers') || '[]');
    const idx = customers.findIndex(c => c.id === data.id);
    if (idx === -1) {
      customers.push(data);
    } else {
      customers[idx] = data;
    }
    localStorage.setItem('customers', JSON.stringify(customers));

    // 下一步
    window.location.href = 'parcel_tracking.html';
  }

  // 頁面載入時：初始化角色 + 若帳號空白就順便產生一個
  initRole();
  if (!document.getElementById('custId').value) {
    generateCustomerId();
  }
</script>

</body>
</html>
